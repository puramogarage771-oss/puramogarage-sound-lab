<script>
let ctx = null;
let osc = null;

const freqSlider = document.getElementById("freq");
const freqVal = document.getElementById("freqVal");
const halfVal = document.getElementById("halfVal");
const picCode = document.getElementById("picCode");

function update(){
  const f = Number(freqSlider.value);
  const half = Math.round(1000000 / (f * 2));
  freqVal.textContent = f;
  halfVal.textContent = half;
  picCode.textContent = `// PIC tone call\ntone(${half}, 300);`;
  if(osc) osc.frequency.value = f;
}

async function start(){
  if(!ctx){
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    await ctx.resume();   // ★超重要
    osc = ctx.createOscillator();
    osc.type = "square";
    osc.frequency.value = freqSlider.value;
    osc.connect(ctx.destination);
    osc.start();
  }else{
    await ctx.resume();   // 再開用
  }
}

function stop(){
  if(osc){
    osc.stop();
    osc.disconnect();
    osc = null;
  }
  if(ctx){
    ctx.close();
    ctx = null;
  }
}

function setFreq(f){
  freqSlider.value = f;
  update();
}

freqSlider.addEventListener("input", update);
update();
</script>

