<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PURAMO GARAGE | SOUND LAB - Keyboard</title>
<style>
  :root{
    --bg:#000;
    --neon:#00ffcc;
    --panel:#020404;
  }
  body{
    margin:0;
    background:var(--bg);
    color:var(--neon);
    font-family: monospace;
    padding:20px;
  }
  h1{font-size:22px;margin:0 0 8px;}
  .small{opacity:.85;font-size:13px;margin:0 0 14px;}
  .panel{
    border:1px solid var(--neon);
    padding:14px;
    margin:14px 0;
    background: rgba(0,0,0,.35);
  }
  button{
    background:transparent;
    color:var(--neon);
    border:1px solid var(--neon);
    padding:8px 12px;
    cursor:pointer;
    margin:4px 6px 4px 0;
  }
  button:hover{background:var(--neon);color:#000;}
  .row{display:flex;flex-wrap:wrap;align-items:center;gap:8px;}
  .readout{
    font-size:16px;
    margin-top:10px;
    line-height:1.7;
  }
  .code{
    margin-top:10px;
    border:1px solid var(--neon);
    background:var(--panel);
    padding:10px;
    white-space:pre;
    font-size:14px;
    overflow:auto;
  }

  /* ===== Keyboard ===== */
  .keyboard-wrap{
    width:min(900px, 100%);
    position:relative;
    user-select:none;
    touch-action:none; /* pointer events */
    margin-top:10px;
  }
  .white-keys{
    display:grid;
    grid-template-columns: repeat(8, 1fr); /* C4..C5 = 8 white keys */
    gap:6px;
  }
  .white{
    height:240px;
    border:1px solid var(--neon);
    background:#fff;
    color:#000;
    border-radius:8px;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding-bottom:8px;
    font-size:12px;
    box-sizing:border-box;
    cursor:pointer;
  }
  .white.active{
    background: #dff;
    outline:2px solid var(--neon);
  }

  .black-keys{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:160px;
    pointer-events:none; /* black keys handle their own events */
  }
  /* black key positions over gaps between whites:
     C# over between C and D, D# between D and E, F# between F and G, G# between G and A, A# between A and B
  */
  .black{
    position:absolute;
    width:11%;
    height:160px;
    background:#111;
    border:1px solid var(--neon);
    border-radius:8px;
    color:var(--neon);
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding-bottom:8px;
    font-size:11px;
    box-sizing:border-box;
    cursor:pointer;
    pointer-events:auto;
  }
  .black.active{
    background:#033;
    outline:2px solid var(--neon);
  }
  /* Fine-tuned positions (percent) for 8 whites */
  .b-cs{ left: 7.5%;  }   /* between white 1 and 2 */
  .b-ds{ left: 19.5%; }   /* between white 2 and 3 */
  .b-fs{ left: 43.5%; }   /* between white 4 and 5 */
  .b-gs{ left: 55.5%; }   /* between white 5 and 6 */
  .b-as{ left: 67.5%; }   /* between white 6 and 7 */

  .hint{
    margin-top:10px;
    opacity:.9;
    font-size:13px;
  }
</style>
</head>
<body>

<h1>ğŸ¹ PURAMO GARAGE â€“ SOUND LAB (Keyboard)</h1>
<p class="small">
æœ€åˆã«ã€Œâ–¶ éŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’1å›ã‚¯ãƒªãƒƒã‚¯ â†’ éµç›¤ã‚’æŠ¼ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—é•·æŠ¼ã—ã§é³´ã‚Šç¶šã‘ã‚‹ï¼‰
</p>

<div class="panel">
  <div class="row">
    <button id="unlockBtn">â–¶ éŸ³ã‚’æœ‰åŠ¹åŒ–</button>
    <button id="stopBtn">â–  å…¨åœæ­¢</button>
    <button id="copyBtn">COPY tone()</button>
  </div>

  <div class="readout" id="readout">
    Note: - / Hz: - / half_period: -
  </div>

  <div class="code" id="codeBox">tone(1908, 300);</div>

  <div class="hint">
    half_period(us) = 1,000,000 / (Hz Ã— 2)ã€€â€»PICå®Ÿæ©Ÿã¯ -10ã€œ15%è£œæ­£ãŒç›®å®‰
  </div>
</div>

<div class="panel">
  <h2 style="margin:0 0 8px;font-size:16px;">éµç›¤ï¼ˆC4 â†’ C5ï¼‰</h2>

  <div class="keyboard-wrap" id="keyboard">
    <div class="white-keys" id="whiteKeys"></div>

    <div class="black-keys">
      <div class="black b-cs" data-note="C#4">C#</div>
      <div class="black b-ds" data-note="D#4">D#</div>
      <div class="black b-fs" data-note="F#4">F#</div>
      <div class="black b-gs" data-note="G#4">G#</div>
      <div class="black b-as" data-note="A#4">A#</div>
    </div>
  </div>

  <p class="small" style="margin-top:10px;">
    ç™½éµ: C D E F G A B C / é»’éµ: C# D# F# G# A#
  </p>
</div>

<script>
/** ===== Web Audio Core ===== */
let ctx = null;
let masterGain = null;

// ã„ã¾é³´ã£ã¦ã„ã‚‹ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ã‚’ç®¡ç†ï¼ˆæŠ¼ã—ã£ã±ãªã—å¯¾å¿œï¼‰
const active = new Map(); // keyId -> {osc, gain}

const noteTable = {
  "C4": 261.6256,
  "C#4": 277.1826,
  "D4": 293.6648,
  "D#4": 311.1270,
  "E4": 329.6276,
  "F4": 349.2282,
  "F#4": 369.9944,
  "G4": 391.9954,
  "G#4": 415.3047,
  "A4": 440.0000,
  "A#4": 466.1638,
  "B4": 493.8833,
  "C5": 523.2511
};

const readout = document.getElementById("readout");
const codeBox = document.getElementById("codeBox");
const unlockBtn = document.getElementById("unlockBtn");
const stopBtn = document.getElementById("stopBtn");
const copyBtn = document.getElementById("copyBtn");

function halfPeriodUs(hz){
  return Math.round(1000000 / (hz * 2));
}

function updateUI(note){
  const hz = noteTable[note];
  const half = halfPeriodUs(hz);
  readout.textContent = `Note: ${note} / Hz: ${hz.toFixed(1)} / half_period: ${half} us`;
  codeBox.textContent = `// ${note} (${hz.toFixed(1)}Hz)\ntone(${half}, 300);`;
}

async function ensureAudio(){
  if(!ctx){
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = ctx.createGain();
    masterGain.gain.value = 0.2; // éŸ³é‡ï¼ˆå¤§ãã„ã¨è€³ãŒç–²ã‚Œã‚‹ã®ã§æ§ãˆã‚ï¼‰
    masterGain.connect(ctx.destination);
  }
  await ctx.resume();
}

function startNote(note, keyId){
  const hz = noteTable[note];
  if(!hz) return;

  // ã™ã§ã«é³´ã£ã¦ãŸã‚‰äºŒé‡èµ·å‹•ã—ãªã„
  if(active.has(keyId)) return;

  const osc = ctx.createOscillator();
  osc.type = "square"; // PICã£ã½ã„
  osc.frequency.value = hz;

  const g = ctx.createGain();
  g.gain.value = 0.0;

  // çŸ©å½¢æ³¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å°‘ã—ã ã‘æŠ‘ãˆã‚‹ï¼ˆè¶…çŸ­ã„ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰
  const now = ctx.currentTime;
  g.gain.setValueAtTime(0.0, now);
  g.gain.linearRampToValueAtTime(1.0, now + 0.005);

  osc.connect(g);
  g.connect(masterGain);
  osc.start();

  active.set(keyId, {osc, gain:g});
  updateUI(note);
}

function stopNote(keyId){
  const obj = active.get(keyId);
  if(!obj) return;

  const now = ctx.currentTime;
  obj.gain.gain.cancelScheduledValues(now);
  obj.gain.gain.setValueAtTime(obj.gain.gain.value, now);
  obj.gain.gain.linearRampToValueAtTime(0.0, now + 0.01);

  setTimeout(() => {
    try{ obj.osc.stop(); }catch(e){}
    try{ obj.osc.disconnect(); }catch(e){}
    try{ obj.gain.disconnect(); }catch(e){}
  }, 20);

  active.delete(keyId);
}

function stopAll(){
  for(const keyId of Array.from(active.keys())){
    stopNote(keyId);
  }
}

/** ===== UI: build white keys ===== */
const whiteOrder = ["C4","D4","E4","F4","G4","A4","B4","C5"];
const whiteNames = {"C4":"C","D4":"D","E4":"E","F4":"F","G4":"G","A4":"A","B4":"B","C5":"C"};
const whiteKeys = document.getElementById("whiteKeys");

whiteOrder.forEach((note, i) => {
  const div = document.createElement("div");
  div.className = "white";
  div.dataset.note = note;
  div.textContent = whiteNames[note];
  whiteKeys.appendChild(div);
});

/** ===== Pointer events for both mouse & touch ===== */
function bindKey(el){
  const note = el.dataset.note;
  const keyId = el.classList.contains("black") ? `b-${note}` : `w-${note}`;

  el.addEventListener("pointerdown", async (ev) => {
    ev.preventDefault();
    await ensureAudio();
    startNote(note, keyId);
    el.classList.add("active");
    el.setPointerCapture(ev.pointerId);
  });

  el.addEventListener("pointerup", (ev) => {
    ev.preventDefault();
    stopNote(keyId);
    el.classList.remove("active");
  });

  el.addEventListener("pointercancel", (ev) => {
    ev.preventDefault();
    stopNote(keyId);
    el.classList.remove("active");
  });

  el.addEventListener("pointerleave", (ev) => {
    // æŠ¼ã—ã£ã±ãªã—ã§å¤–ã¸å‡ºãŸã¨ãã‚‚æ­¢ã‚ãŸã„å ´åˆã¯ã“ã“ã§æ­¢ã‚ã‚‹
    // ãŸã ã—ã€PointerCaptureä¸­ã¯leaveãŒæ¥ãªã„ã“ã¨ã‚‚ã‚ã‚‹
  });
}

document.querySelectorAll(".white").forEach(bindKey);
document.querySelectorAll(".black").forEach(bindKey);

/** ===== Buttons ===== */
unlockBtn.addEventListener("click", async () => {
  await ensureAudio();
  // ä¸€ç¬ã ã‘ç„¡éŸ³ã§èµ·å‹•ç¢ºèª
  readout.textContent = "Audio: unlocked âœ…  éµç›¤ã‚’æŠ¼ã—ã¦ã­";
});

stopBtn.addEventListener("click", () => {
  stopAll();
});

copyBtn.addEventListener("click", async () => {
  const text = codeBox.textContent;
  try{
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = "COPIED âœ…";
    setTimeout(()=> copyBtn.textContent="COPY tone()", 800);
  }catch(e){
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒãƒ€ãƒ¡ãªç’°å¢ƒå‘ã‘
    alert("ã‚³ãƒ”ãƒ¼ã§ããªã„ç’°å¢ƒã§ã™ã€‚ã‚³ãƒ¼ãƒ‰æ ã‹ã‚‰æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã­ã€‚");
  }
});

// åˆæœŸè¡¨ç¤º
readout.textContent = "Audio: locked (â–¶ éŸ³ã‚’æœ‰åŠ¹åŒ– ã‚’ã‚¯ãƒªãƒƒã‚¯)";
codeBox.textContent = "tone(1908, 300);";
</script>

</body>
</html>

